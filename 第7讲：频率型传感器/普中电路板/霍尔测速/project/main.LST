C51 COMPILER V9.60.0.0   MAIN                                                              06/14/2024 12:29:37 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: E:\danpianji\Keil 5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          //本工程基于普中单片机开发板，晶振12MHz
   2          #include <config.h> 
   3          #include "alarm.h"
   4          #include "delay.h"
   5          #include "seg.h"
   6          
   7          
   8          
   9          u8 K=0; //统计T1中断次数，中断20次为1秒
  10          u16 n=0;//1秒后的T0计数值，即1秒后流量传感器转动圈数
  11          
  12          //u8 str_buf[20];
  13          //void Alarm(u8 t) //蜂鸣器报警,持续t秒,软件延时
  14          //{
  15          //  u8 k; 
  16          //  u16 i,j;    
  17          //  for(k=0;k<t;k++)
  18          //  {
  19          //    for(i=0;i<200;i++)//叮
  20          //    {  beep=0;delay_us(50);beep=1;delay_us(50);  }
  21          //    for(j=0;j<100;j++)//咚
  22          //        {  beep=0;delay_us(110);beep=1;delay_us(110);}
  23          //  }
  24          //}
  25          
  26          void ET_Init()//定时器计数器初始化
  27          {
  28   1      //T0工作于计数器模式，以流量传感器输出为外部计数脉冲，计数初值为0
  29   1      //T1工作于定时器模式，定时50ms，中断20次，为1秒
  30   1      //每隔1秒读出T0的计数值，即为1秒钟流量传感器转动圈数
  31   1        K=0;  //统计T1中断次数，中断20次为1秒
  32   1        TMOD=0X15;//计数器T0工作方式1、软启动、计数；定时器1工作方式1、软启动、定时 
  33   1        TH0=0;  //T0计数初值为0
  34   1        TL0=0;
  35   1      //  TH1=19664/256;//T1计数初值19664，晶振11.0592MHz，定时50ms，计数值45872，计数初值19664
  36   1      //  TL1=19664%256;
  37   1        TH1=0xB0;//定时初值
  38   1        TL1=0x3c;
  39   1        EA=1;  //中断总允许
  40   1        ET1=1; //T1中断允许
  41   1        TR0=1;  //启动计数器T0
  42   1        TR1=1;  //启动定时器T1  
  43   1      }
  44          
  45          void main()
  46          { 
  47   1        
  48   1        float q;//流量，单位：升/分钟
  49   1        float total_volume=10.0;//总容量
  50   1        float current_volume=0;//当前水量
  51   1        u8 percentage_filled=0;//当前水量占比
  52   1      
  53   1      
  54   1        while(1) //每隔1s统计一次流量
  55   1        {    
C51 COMPILER V9.60.0.0   MAIN                                                              06/14/2024 12:29:37 PAGE 2   

  56   2          ET_Init();  //定时器计数器初始化
  57   2          while(K<20);//等待1s 
  58   2          q=n*60/7.5; //计算流量，单位：转/分钟
  59   2          current_volume+=q;//更新当前水量
  60   2          percentage_filled = (current_volume / total_volume) * 100;
  61   2          sprintf(seg_buf, "%d%%", percentage_filled);//将百分数传到字符串里
  62   2          seg_tran(seg_buf,seg_cod);//转码
  63   2            if(percentage_filled >= 100) {
  64   3                  led_ctrl(4,ON);alarm=1;
  65   3              } else {
  66   3                  led_ctrl(4,OFF);alarm=0;
  67   3              }
  68   2        }
  69   1      }
  70          
  71          
  72          void T1_INT() interrupt 3
  73          {
  74   1        K++;  //每中断一次(50ms)，计数值加1，中断20次即为1s
  75   1        if(K==20) 
  76   1        {
  77   2          TR0=0; //关闭计数器0
  78   2          TR1=0; //关闭定时器1
  79   2          n=TH0;
  80   2          n=n*256+TL0; //1秒后的T0计数值，即1秒后流量传感器转动圈数      
  81   2        }
  82   1        else
  83   1        { 
  84   2      //        TH1=19664/256;//不足20次时，重装初值，继续计时
  85   2      //        TL1=19664%256;
  86   2          TH1=0xB0;//定时初值
  87   2          TL1=0x3c;
  88   2          }           
  89   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    293    ----
   CONSTANT SIZE    =      5    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3      13
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
